/*!
 * Purpose: this simple framework manages all widgets creation in an async manner 
 * Version Release: 2.0
 * Created Date: March 22, 2023
 * Author(s):Enoch C. Jallah
 * Contact Mail: enochcjallah@gmail.com
*/
export class PageLessComponent{constructor(e,t){void 0===window.PageLessComponent&&(window.PageLessComponent=PageLessComponent),null==PageLessComponent.instances&&(PageLessComponent.instances=[]),null==PageLessComponent.instances[e]&&(PageLessComponent.instances[e]=t),this.props=null!=t.props&&"object"==typeof t.props?t.props:{},this.parseHTMLString=t.view,this.callback=t.callback,this.isRendered=!1,this.isPageLessComponent=!0,this.components=[],PageLessComponent.supportedEvents=["onclick","onchange","onmouseenter","onmouseleave","onsubmit","onkeyup","onkeydown","onfocusin","onfocusout","onblur","onfocus","onscroll","onload"],this.creator=e.includes("table-row")?document.createElement("tbody"):document.createElement("div"),this.setRawData(t.data),this.creator.innerHTML=this.parseHTMLString().trim(),this.finalView=this.creator.firstChild,this.instanceTagName=e,this.setRawProps(this.finalView),this.renderComponents(this.finalView),this.addToDOM(this.finalView),"function"==typeof this.finalView.callback&&(this.finalView.callback=this.finalView.callback.bind(this.finalView),this.finalView.callback())}view(){return this.finalView}ready(e){"function"==typeof e&&!0===this.isRendered&&e.call(this)}renderComponents(e){return new Promise(t=>{this.getComponents(e).then(t=>{t.forEach((t,s)=>{this.getNewInstance(t,s).then(s=>{t.rendered=s.setData(t.properties),t.rendered.instanceTagName=t.instanceName,t.rendered.parentComponent=e,t.rendered.allParentComponents=[];let n=e;for(;null!=n;)t.rendered.allParentComponents[n.instanceTagName]=n,n=n.parentComponent;t.rendered.isRendered=!0,t.rendered.ready=s.ready.bind(t.rendered),t.element.replaceWith(t.rendered),t.rendered.setProps(t.rendered,t.events),"function"==typeof t.rendered.callback&&t.rendered.callback.call(t.rendered)})})}),t()})}parentComponents(e){let t=this.allParentComponents[e];if(void 0!==t)return t;throw`{${e}} is not a parent of the child component {${this.instanceTagName}}`}static Render(e){let t=document.createElement("div");t.innerHTML=e.trim();let s=t.firstChild,n=s.nodeName.toLowerCase(),i=window.PageLessComponent.instances[n],a={},o={};if(null!=i){let e=s.attributes;for(let t=0;t<e.length;t++)if(a[e[t].name]=e[t].value,PageLessComponent.supportedEvents.includes(e[t].name)){let n=PageLessComponent.propsIsEvent(s[e[t].name]),i=!1!==n?n:s[e[t].name];"function"!=typeof i&&"string"!=typeof i||(o[e[t].name]=i)}let t=`${n}_${s.nodeName}_manual0`,r=new PageLessComponent(t,i);delete PageLessComponent.instances[t];let l=r.setData(a);return l.parentComponent=null,l.isRendered=!0,l.ready=r.ready.bind(l),s.replaceWith(l),l.setProps(l,o),"function"==typeof l.callback&&l.callback.call(l),l}throw`Invalid Component ${n} provided. Unable to located component instance`}static propsIsEvent(e){let t=/{{this\.props\.([a-z]+)}}/m,s=!1,n;return null!=e&&("function"==typeof e?n=e.toString().match(t):"string"==typeof e&&(n=e.toString().match(t)),null!=n&&(s=n[1])),s}getComponents(e){let t=[];return new Promise(s=>{for(const s in window.PageLessComponent.instances){const n=e.querySelectorAll(s);if(n.length>=1)for(const e in n)if(n.hasOwnProperty(e)){const i=n[e],a={},o={},r=i.attributes;for(let e=0;e<r.length;e++)if(a[r[e].name]=r[e].value,PageLessComponent.supportedEvents.includes(r[e].name)){let t=PageLessComponent.propsIsEvent(i[r[e].name]),s=!1!==t?t:i[r[e].name];"function"!=typeof s&&"string"!=typeof s||(o[r[e].name]=s)}const l={instanceName:s,element:i,properties:a,events:o};t.push(l)}}s(t)})}getNewInstance(e,t){return new Promise(s=>{const n=`${e.instanceName}_${e.element.nodeName}_${t}`,i=new PageLessComponent(n,window.PageLessComponent.instances[e.instanceName]);delete PageLessComponent.instances[n],s(i)})}addToDOM(e){return new Promise(t=>{for(const t in this)if(this.hasOwnProperty(t)){const s=this[t];!1===e.hasOwnProperty(t)&&!1===/^([0-9]+)$/.test(t)&&Object.defineProperty(e,t,{value:s,writable:!0})}Object.defineProperty(e,"props",{value:this.props,writable:!0}),Object.defineProperty(e,"callback",{value:this.callback,writable:!0}),Object.defineProperty(e,"parseHTMLString",{value:this.parseHTMLString,writable:!0}),Object.defineProperty(e,"name",{value:this.name,writable:!0}),Object.defineProperty(e,"components",{value:this.components,writable:!0}),Object.defineProperty(e,"finalView",{value:e,writable:!0}),Object.defineProperty(e,"creator",{value:this.creator,writable:!0}),Object.defineProperty(e,"isRendered",{value:this.isRendered,writable:!0}),Object.defineProperty(e,"addToDOM",{value:this.addToDOM,writable:!0}),Object.defineProperty(e,"getComponents",{value:this.getComponents,writable:!0}),Object.defineProperty(e,"getNewInstance",{value:this.getNewInstance,writable:!0}),Object.defineProperty(e,"renderComponents",{value:this.renderComponents,writable:!0}),Object.defineProperty(e,"setData",{value:this.setData,writable:!0}),Object.defineProperty(e,"setRawProps",{value:this.setRawProps,writable:!0}),Object.defineProperty(e,"setProps",{value:this.setProps,writable:!0}),Object.defineProperty(e,"parentComponents",{value:this.parentComponents,writable:!0}),Object.defineProperty(e,"setRawData",{value:this.setRawData,writable:!0}),Object.defineProperty(e,"refresh",{value:this.refresh,writable:!0}),Object.defineProperty(e,"ready",{value:this.ready,writable:!0}),t()})}setRawProps(e,t=this.props){for(const s in t)if(null!=e.getAttribute(s)&&null!=e.getAttribute(s)){const n=t[s];PageLessComponent.supportedEvents.includes(s)&&null!=e.props?(e.props[s]=n,e.addEventListener(s.replace("on",""),e.props[s])):e[s]=t[s]}}setProps(e,t){for(let s in t){let n=t[s];if("function"==typeof n)e.props[s]=n.bind(e),e[s]=e.props[s];else{let t=e.parentComponent,i=!1;for(;null!=t;)null!=t.props[n]&&(e.props[s]=t.props[n],e.addEventListener(s.replace("on",""),e.props[s]),i=!0),t=t.parentComponent;if(!1===i){if(null==e.props[n])throw`Prop ${n} handler not found`;e.props[s]=e.props[n].bind(e),e.addEventListener(s.replace("on",""),e.props[s])}}}}static isJSONData(e){if("string"!=typeof e)return!1;try{e=JSON.parse(e)}catch(e){return!1}return"object"==typeof e&&null!==e}setRawData(e){return new Promise(t=>{for(let t in e)!0===PageLessComponent.isJSONData(e[t])&&(e[t]=JSON.parse(e[t])),this[t]=e[t];t()})}setData(e){this.setRawData(e);const t=this.finalView;this.creator.innerHTML=this.parseHTMLString().trim();let s=this.creator.firstChild,n;return Object.getOwnPropertyNames(this).forEach(e=>{this.hasOwnProperty(e)&&!1===s.hasOwnProperty(e)&&!1===/^([0-9]+)$/.test(e)&&Object.defineProperty(s,e,{value:this[e],writable:!0})}),this.setRawProps(s),this.renderComponents(s),this.addToDOM(s),t.replaceWith(s),s}refresh(e=!1){if(!1===e){let e=this.setData({});return"function"==typeof e.callback&&e.callback.call(e),e}return"function"==typeof this.callback&&this.callback.call(this),this.finalView}}export class PageLess{constructor(e=null){this.mainContentContainer=document.querySelector("body"),this.toastContainer=this.mainContentContainer,this.entryAnimation="fadeIn",this.exitAnimation="fadeOut",this.Page404="404",this.modulesLocation="./modules",this.sharedModulesLocation=null,this.zIndex=1,this.widget=null,this.data=null,this.urlData=null,PageLess.appName=null,this.url=e,this.routes=[],this.urlSearch={},this.previousURLs=[]}route(e=this.url,t=!0){if(null==window.PageLess&&(window.PageLess=PageLess),null==PageLess.MainContentContainer&&(PageLess.MainContentContainer=this.mainContentContainer),null==PageLess.AppName&&(PageLess.AppName=this.appName),null==PageLess.Routes&&(PageLess.Routes=this.routes),null==PageLess.ModulesLocation&&(PageLess.ModulesLocation=this.modulesLocation),null==PageLess.SharedModulesLocation&&(PageLess.SharedModulesLocation=this.sharedModulesLocation),null==PageLess.CurrentPage&&(PageLess.CurrentPage=0),null==PageLess.URLData&&(PageLess.URLData=[]),null==PageLess.URLSearchData&&(PageLess.URLSearchData=[]),null==PageLess.Pages&&(PageLess.Pages=[]),null==PageLess.Page404&&(PageLess.Page404=this.Page404),null==PageLess.EntryAnimation&&(PageLess.EntryAnimation=this.entryAnimation),null==PageLess.ExitAnimation&&(PageLess.ExitAnimation=this.exitAnimation),null==PageLess.ToastContainer&&(PageLess.ToastContainer=this.toastContainer),null===this.url&&(this.url=e),null!=e)return PageLess.PrevURL=PageLess.GetURL("path"),PageLess.setURL(PageLess.AppName,e),new Promise(s=>{let n=PageLess.Pages[e];if(null==n){let n=!1,i=e.split("?")[0];PageLess.Routes.forEach(a=>{if(1==a.routePattern.test(i)){const o=void 0!==a.shared&&!0===a.shared&&a.shared;let r;if(PageLess.URLSearchData[i]={},new URL(`${window.location.origin}${e}`).searchParams.forEach((e,t)=>{this.urlSearch[t]=e,PageLess.URLSearchData[i][t]=e}),PageLess.URLData[i]=a.routePattern.exec(i),void 0!==this[a.widget]){if(this[a.widget](),this.widget.isPageLessComponent){this.widget.finalView.PageLess=this,this.widget.finalView.urlData=this.urlData;let e=this.widget.finalView.setData;this.widget.finalView.setData=t=>(this.widget.finalView=e.call(this.widget.finalView,t),this.setURLAttr(),this.widget.finalView),this.setURLAttr(),PageLess.Display(this.widget,t).then(e=>s(e))}n=!0}else PageLess.StartLoader(),PageLess.Import(a.widget,o).then(e=>{if(PageLess.StopLoader(),this.widget=e,this.widget.isPageLessComponent){this.widget.finalView=void 0!==PageLess[a.widget]?e.refresh():this.widget.finalView,PageLess[a.widget]=this.widget,this.widget.finalView.PageLess=this,this.widget.finalView.urlData=this.urlData;let n=this.widget.finalView.setData;this.widget.finalView.setData=e=>(this.widget.finalView=n.call(this.widget.finalView,e),this.setURLAttr(),this.widget.finalView),this.setURLAttr(),PageLess.Display(this.widget,t).then(e=>s(e))}}),n=!0}}),0==n&&(void 0!==this[PageLess.Page404]?(this[PageLess.Page404](),this.widget.finalView.PageLess=this,this.setURLAttr(),PageLess.Display(this.widget).then(e=>s(e))):(PageLess.StartLoader(),PageLess.Import(PageLess.Page404).then(e=>{if(PageLess.StopLoader(),this.widget=e,this.widget.isPageLessComponent){this.widget.finalView.PageLess=this;let e=this.widget.finalView.setData;this.widget.finalView.setData=t=>(this.widget.finalView=e.call(this.widget.finalView,t),this.setURLAttr(),this.widget.finalView)}this.setURLAttr(),PageLess.Display(this.widget).then(e=>s(e))})))}else this.widget=n,PageLess.Display(this.widget,t).then(e=>{if(!0===t){let t=this.widget.finalView.PageLess.previousURLs;this.widget.finalView=e.refresh(),this.widget.finalView.PageLess=this,this.widget.finalView.PageLess.previousURLs=t;let s=this.widget.finalView.setData;this.widget.finalView.setData=e=>(this.widget.finalView=s.call(this.widget.finalView,e),this.setURLAttr(),this.widget.finalView)}s(e)})})}static Display(e,t=!0){return new Promise(s=>{if(e.isPageLessComponent){let n=PageLess.PrevURL,i=PageLess.CurrentPage,a;(0!==i?PageLess.Undisplay(i):new Promise(e=>{e()})).then(()=>{PageLess.AddPage(e).then(()=>{e.finalView.style.zIndex=1,e.finalView.classList.add("animated",PageLess.EntryAnimation,"faster"),!0===t&&n!=e.finalView.PageLess.url&&e.finalView.PageLess.setPreviousURL(n),PageLess.MainContentContainer.appendChild(e.finalView);let removeAnimation=()=>{e.finalView.classList.remove("animated",PageLess.EntryAnimation,"faster"),e.finalView.removeEventListener("animationend",removeAnimation)};e.finalView.addEventListener("animationend",removeAnimation),s(e)})})}})}static Undisplay(e){return new Promise(t=>{e.isPageLessComponent&&(e.finalView.style.zIndex=-1,e.finalView.remove(),t(e))})}static Import(e,t=!1){return new Promise(s=>{!1===t?import(`${PageLess.ModulesLocation}/${e}.js`).then(e=>{s("function"==typeof e.widget?e.widget():e.widget)}).catch(e=>{console.log(e)}):null!==PageLess.SharedModulesLocation?import(`${PageLess.SharedModulesLocation}/${e}.js`).then(e=>{s("function"==typeof e.widget?e.widget():e.widget)}).catch(e=>{console.log(e)}):console.error("Unable to load module. Shared modules location hasn't been set")})}setURLAttr(){let e=`${this.url}`;this.widget.isPageLessComponent&&(this.widget.finalView.setAttribute("url-title",this.appName),this.widget.finalView.setAttribute("url",e))}setPreviousURL(e){this.widget.isPageLessComponent&&this.widget.finalView.PageLess.previousURLs.push(e)}static AddPage(e){return new Promise(t=>{PageLess.Pages[e.finalView.PageLess.url]=e,PageLess.CurrentPage=e,t(PageLess.Pages)})}static GetURL(e="full-url"){let t=window.location,s=t.pathname,n=t.pathname.split("/"),i=null;switch(e){case"full-url":i=t.href;break;case"path":i=`${s}${t.search}`;break;case"paths":i=n;break;default:throw"Invalid Returned Content Provided"}return i}static GetURLData(){const e=window.location,t=e.pathname,s=PageLess.URLData[t];let n=!1;return void 0!==s&&(n=s),n}static GetURLSearchData(){const e=window.location,t=e.pathname,s=PageLess.URLSearchData[t];let n=!1;return void 0!==s&&(n=s),n}static setURL(e,t){let s={pageTitle:e,pageUrl:t};history.pushState(s,s.pageTitle,s.pageUrl),document.title=e}getContent(e){return new Promise(t=>{Object.getPrototypeOf(this).hasOwnProperty(e)&&(this[e](),t(this.widget))})}findById(e){return new Promise(t=>{let s=this.mainContentContainer.querySelector(`#${e}`);null!=s?(this.widget=s,t(s)):t(!1)})}findByURL(e){return new Promise(t=>{let s=this.mainContentContainer.children();if(s.length>=1){let n=!1;s.forEach(t=>{let s;t.getAttribute("url")==e&&(n=jqChild)}),this.widget=n,t(this.widget)}else t(!1)})}static GoBack(){return new Promise(e=>{let t=PageLess.CurrentPage;if(t.isPageLessComponent){let s=t.finalView.PageLess.previousURLs.pop();null!=s?(new PageLess).route(s,!1).then(t=>e(t)):t.finalView.PageLess.goToStart()}})}static ClearHistory(){return new Promise(e=>{PageLess.CurrentPage=0,PageLess.Pages=[],e()})}goToStart(){console.warn("This is the last page. You must override {GoToStart} Method. You haven't overriden {GoToStart} Method yet")}refresh(){let e=this.widget;this.url=PageLess.getURL("path").replace(`/${PageLess.getURL("paths")[1]}/`,""),this.route().then(t=>{e.remove()})}static IsJSONData(e){if("string"!=typeof e)return!1;try{e=JSON.parse(e)}catch(e){return!1}return"object"==typeof e&&null!==e}static async Request(e,t=!1){"function"==typeof e.beforeSend&&e.beforeSend(),!0===t&&(void 0!==e.data&&!0!==PageLess.IsJSONData(e.data)&&(e.data=JSON.stringify(e.data)),void 0===e.contentType&&(e.contentType="application/json"));const s=e.url;let n=void 0!==e.type?e.type.toUpperCase():e.method.toUpperCase(),i="",a={method:n,mode:"same-origin",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":void 0===e.contentType?"application/x-www-form-urlencoded":e.contentType},redirect:"follow",referrerPolicy:"no-referrer"};"GET"!=n&&"HEAD"!=n||void 0===e.data||""==e.data?a.body=e.data:i=`?${new URLSearchParams(e.data).toString()}`;const o=await fetch(s+i,a);return o.json()}static ImageRequest(e){return new Promise((t,s)=>{let n=null!=e.url?e.url:Widget.API(),i=e.formData,a=null!=e.onProgress&&"function"==typeof e.onProgress?e.onProgress:()=>{},o=new XMLHttpRequest;o.open("POST",n),o.upload.addEventListener("progress",a.bind(i)),o.addEventListener("load",(function(e){let s=o.response;!0===PageLess.IsJSONData(s)&&(s=JSON.parse(s)),t(s)})),o.send(i)})}static ChangeButtonState(e,t="Processing"){let s=e.innerHTML;e.innerHTML=`<span>${t}&nbsp;<i class="fad fa-md fa-spinner-third fa-spin"></i></span>`,e.setAttribute("data-oldtext",s),e.setAttribute("disabled","disabled")}static RestoreButtonState(e){let t=e.getAttribute("data-oldtext");e.innerHTML=t,e.removeAttribute("disabled")}static ContextMenu(e,t){let s=document.createElement("div");s.classList.add("context-menu"),s.style.cssText="\n            right: 10px;\n            top: 10px; \n        ";let generateContextMenu=()=>(e.forEach(e=>{let t=null==e.class?"":e.class,n=null==e.additionalAttr?"":e.additionalAttr,i=document.createElement("div"),a=`<button ${null!=e.id?`id="${e.id}"`:""} class="menu-item ${t}" ${null!=e.contextId?`context-id="${e.contextId}"`:""} ${n}>${e.text}</button>`;i.innerHTML=a;let o=i.firstChild;o.addEventListener("click",t=>{t.stopPropagation(),null!=e.callback&&"function"==typeof e.callback&&(e.callback(),o.parentElement.remove())}),s.append(o)}),s),closer=e=>{let t=e.target;1!=t.classList.contains("menu-item")&&1!=t.classList.contains("context-menu")&&1!=t.classList.contains("init-context-menu")&&(s.remove(),document.body.removeEventListener("click",closer))};document.body.addEventListener("click",closer);let n=document.querySelectorAll(".context-menu");n.length>=1&&n.forEach(e=>{e.remove()});let i=t.parentElement;i.style.position="relative !important",i.append(generateContextMenu())}static Toast(e,t,s=2e3){const n=PageLess.ToastContainer,i=new PageLessComponent("custom-toast",{data:{type:e,text:t,timer:s},view:function(){return`\n                    <div class="w-100 position-absolute" style="bottom: 50px; z-index: 10000">\n                        <div class="w-100 d-flex justify-content-center px-md-3">\n                            <div class="animated zoomIn faster w-auto toast toast-${this.type} w-100px ${this.identity} ${this.classname}" id="${this.identity}" onclick="{{this.props.onclick}}" style="${this.style}">\n                                ${this.text}&nbsp;\n                            </div>\n                        </div>\n                    </div>\n                `}});n.style.position="relative",n.appendChild(i.view()),setTimeout(()=>{n.removeChild(i.view())},s)}static StartLoader(e=2500){const t=document.body,s=new PageLessComponent("header-loader",{data:{duration:e,animation:null},props:{stop:function(){this.props.stopAnimation.call(this).then(()=>{this.remove()})},stopAnimation:function(){return new Promise(e=>{null!==this.animation&&this.animation.cancel(),e()})}},view:function(){return'\n                    <div class="pageless-loader" style="width: 100% !important;">\n                        <div style="position: absolute !important; top: 0 !important; z-index: 1000 !important; height: 3px; width: 0px; background-color: #dc3545;"></div> \n                    </div>\n                '},callback:function(){const e=[{width:"0%"},{width:"100%"},{right:"0"}],t={duration:this.duration,iterations:1/0,easing:"ease-in-out"};this.animation=this.querySelector("div").animate(e,t)}});t.style.position="relative",t.appendChild(s.view())}static StopLoader(){let e=document.querySelectorAll(".pageless-loader");null!=e&&e.forEach(e=>{e.props.stop.call(e)})}static ManualDownload(e,t,s){return new Promise(n=>{let i=new Blob([e],{type:s}),a=document.createElement("a");a.href=URL.createObjectURL(i),a.download=t,a.click(),n()})}static InitFlexScrollersX(e){let t=document.createElement("button"),s=document.createElement("button");t.classList.add("btn-circle","left-scroller","bg-white"),t.setAttribute("clickable","false"),t.innerHTML='<i class="fa fa-2x fa-angle-left"></i>',s.classList.add("btn-circle","right-scroller","bg-white"),s.setAttribute("clickable","true"),s.innerHTML='<i class="fa fa-2x fa-angle-right"></i>',t.addEventListener("click",(function(){let t=e.scrollLeft-e.clientWidth,n=t>0?t:0;e.scroll(n,0),s.setAttribute("clickable","true"),0==n&&this.setAttribute("clickable","false")})),s.addEventListener("click",(function(){let s=e.scrollLeft+e.clientWidth,n=s<e.scrollWidth?s:e.scrollWidth;e.scroll(n,0),t.setAttribute("clickable","true"),n==e.scrollWidth&&this.setAttribute("clickable","false")})),e.parentElement.classList.contains("scroll-x-container-parent")||e.parentElement.classList.add("scroll-x-container-parent"),e.parentElement.appendChild(t),e.parentElement.appendChild(s)}static CamelCase(e){let t,s;return e.charAt(0).toUpperCase()+e.substring(1)}static SlideDown(e,t=250){return new Promise(s=>{e.style.display="block",e.style.overflow="hidden";const n=e.offsetHeight;e.style.height="0px",e.animate([{height:"0px"},{height:`${n}px`}],{fill:"forwards",duration:t,iteration:1,easing:"ease-in-out"}).finished.then(()=>{s(e)})})}static SlideUp(e,t=250){return new Promise(s=>{e.animate([{height:"0px"}],{duration:t,iteration:1,easing:"ease-in-out"}).finished.then(()=>{e.style.display="none",s(e)})})}static SlideToggle(e,t=250){let s;return null==e.expanded||!1===e.expanded?(s=PageLess.SlideDown(e,t),e.expanded=!0):(s=PageLess.SlideUp(e,t),e.expanded=!1),s}static FadeOut(e,t=250){return new Promise(s=>{e.animate([{opacity:1},{opacity:0}],{fill:"forwards",duration:t,iteration:1,easing:"ease-in-out"}).finished.then(()=>{e.style.setProperty("display","none","important"),s(e)})})}static FadeIn(e,t=250){return new Promise(s=>{e.style.removeProperty("display"),e.animate([{opacity:0},{opacity:1}],{fill:"forwards",duration:t,iteration:1,easing:"ease-in-out"}).finished.then(()=>{s(e)})})}}window.onpopstate=e=>{e.preventDefault(),window.PageLess.GoBack()};